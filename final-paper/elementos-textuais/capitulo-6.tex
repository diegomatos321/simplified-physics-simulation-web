\chapter{Resposta a colisão}

Os chamados métodos baseados em penalidades tratam o contato inserindo molas nos pontos de penetração. Embora seja muito simples de implementar, esse método apresenta diversas desvantagens sérias. Por exemplo, é difícil escolher constantes de mola adequadas de forma que, por um lado, os objetos não penetrem demais e, por outro lado, o sistema resultante não se torne instável. Em outros métodos para simulação física, as colisões são tratadas retrocedendo o tempo (por meio de busca binária, por exemplo) até o ponto exato da colisão, tratando a colisão analiticamente a partir desse ponto e, em seguida, reiniciando a simulação. Isso não é muito prático do ponto de vista de tempo real, pois o código pode se tornar muito lento quando há muitas colisões.

\citeonline{jakobsen2001advanced} propõe uma estratégia mais simples, os vértices que fazem parte da colisão são simplesmente projetados para fora do obstáculo. Por projeção, em termos gerais, entendemos mover o ponto o mínimo possível até que ele esteja livre do obstáculo. Normalmente, isso significa mover o ponto perpendicularmente para fora, em direção à superfície de colisão.

\section{Projeção da posição pelo método Jakobsen}

A resposta à uma colisão é composta de dois passos. O primeiro passo consiste em separar os elementos dos objetos (vértice, aresta ou face) que estão se intersectando. Este passo é puramente geométrico, já que é executado movendo as partículas na geometria da colisão.

O segundo passo é um processo de relaxamento iterativo no qual os elementos dos objetos que estão envolvidos na colisão encontram as suas posições apropriadas usando as restrições como suporte.

Se dois objetos convexos A e B colidem o processo de separação requer três parâmetros: os pontos $p_A$ de contato de A, os pontos $p_B$ de contato de B e o ponto $q$ que a simulação assume onde os dois objetos estão em contato chamado de ponto de projeção.

O ponto de projeção coincide com o plano de separação $H(\vec{v}, \delta)$ nas coordenadas locais do objeto, dessa forma como regra geral basta mover os pontos de $p_A$ em direção $H(\vec{v}, \delta)$. Considere dois casos de colisão:

\section{Algoritmo de Expansão de Politopos (EPA)}

Para realizar a separação de dois objetos usando o algoritmo SAT basta calcularmos o MTV como visto na seção \ref{sec:sat}. Já para o GJK é preciso fazer um segundo passo, uma extensão do algoritmo que nos permite encontrar a normal correta e profundidade das colisões.

O Algoritmo de Expansão de Politopos (do inglês Expanding Polytope Algorithm, EPA) cria um polítopo (ou polígono) dentro da Diferença de Minkowski e iterativamente expandi-lo até atingirmos a borda da Diferença de Minkowski. EPA executa essa tarefa utilizando a mesma função de suporte utilizada nos demais algoritmos e a mesma noção de um simplex.

Este algoritmo é uma extensão porque sua entrada é o Simplex final do GJK que contém a origem e encontra o MTV. A distância entre o ponto mais próximo com a origem é a profundidade de penetração ($\delta$). Além disso, o vetor normal para o ponto mais próximo é a direção de separação (ponto de contato). A solução ingênua é usar o normal da face mais próxima da origem, porém um simplex não precisa conter nenhuma das faces do polígono original, o quê pode acabar com uma normal incorreta.

O algoritmo expande o Simplex adicionando vértices a ele até encontrarmos a normal mais próxima de uma face que está no polígono original.

\begin{algorithm}
	\caption{EPA}
	\KwIn{Simplex}
	\KwOut{separation $v$, penetration $\delta$}
	
	\For{$i \leftarrow 0$ \KwTo $i < MAX\_ITERATION$}{
		e $\leftarrow$ Encontrar aresta mais próxima a origem \\
		p $\leftarrow$ Calcular novo ponto de suporte na direção da normal de e \\
		$\delta \leftarrow p \cdot normal(e)$ \\
		\If{$|\delta - length(e)| < TOLERANCE$}{
			\KwRet{normal(e), $\delta$}
		}
		
		Adicionar ponto ao simplex
	}
\end{algorithm}

É importante limitar o número de iterações para evitar que a rotina entre em loop infinito em casos degenerados, como esse algoritmo converge rapidamente uma constante igual a 30 é um bom limite superior. Matematicamente a distância deve ser igual a zero, mas por conta da artimética de ponto flutuante, uma tolerância pequena deve ser aceita, como $10^{-3}$.